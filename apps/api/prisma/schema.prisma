generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== RESTAURANT & USERS ====================

model Restaurant {
  id              String    @id @default(uuid())
  name            String
  slug            String    @unique
  address         String
  city            String
  state           String
  pincode         String
  phone           String
  email           String
  gstin           String?
  fssaiNumber     String?
  logo            String?
  currency        String    @default("INR")
  timezone        String    @default("Asia/Kolkata")
  settings        Json      @default("{}")
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Counters for order/invoice numbering (per restaurant)
  orderCounter    Int       @default(0)
  invoiceCounter  Int       @default(0)
  kotCounter      Int       @default(0)
  fiscalYearStart Int       @default(4) // April = 4 for India

  users           User[]
  categories      Category[]
  menuItems       MenuItem[]
  modifierGroups  ModifierGroup[]
  tables          RestaurantTable[]
  orders          Order[]
  invoices        Invoice[]
  aiConversations AIConversation[]

  @@map("restaurants")
}

model User {
  id              String    @id @default(uuid())
  restaurantId    String
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  email           String
  phone           String
  passwordHash    String
  name            String
  role            UserRole
  pin             String?   // Quick PIN for POS login
  avatar          String?
  isActive        Boolean   @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  sessions        Session[]
  ordersCreated   Order[]   @relation("OrderCreatedBy")
  payments        Payment[]
  aiConversations AIConversation[]
  aiActions       AIAction[]

  @@unique([restaurantId, email])
  @@unique([restaurantId, phone])
  @@unique([restaurantId, pin])
  @@index([restaurantId, isActive])
  @@index([restaurantId, role])
  @@map("users")
}

enum UserRole {
  OWNER
  MANAGER
  CASHIER
  WAITER
  KITCHEN
}

model Session {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token           String    @unique
  refreshToken    String?   @unique
  deviceInfo      Json      @default("{}")
  ipAddress       String?
  expiresAt       DateTime
  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

// ==================== MENU ====================

model Category {
  id              String    @id @default(uuid())
  restaurantId    String
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  image           String?
  sortOrder       Int       @default(0)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  menuItems       MenuItem[]

  @@unique([restaurantId, name])
  @@index([restaurantId, isActive, sortOrder])
  @@map("categories")
}

model MenuItem {
  id              String    @id @default(uuid())
  restaurantId    String
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  categoryId      String
  category        Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name            String
  shortName       String?   // Short name for KDS/receipts
  description     String?
  image           String?
  basePrice       Decimal   @db.Decimal(10, 2)
  taxRate         Decimal   @db.Decimal(5, 2) @default(5.00)
  taxInclusive    Boolean   @default(true)
  isVeg           Boolean   @default(true)
  isAvailable     Boolean   @default(true)
  sortOrder       Int       @default(0)
  preparationTime Int?      // in minutes
  tags            String[]  @default([])
  allergens       String[]  @default([])
  nutritionInfo   Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  modifierLinks   MenuItemModifier[]
  orderItems      OrderItem[]

  @@unique([restaurantId, name])
  @@index([restaurantId, categoryId, isAvailable])
  @@index([restaurantId, isAvailable, sortOrder])
  @@index([restaurantId, name]) // For search
  @@map("menu_items")
}

model ModifierGroup {
  id              String    @id @default(uuid())
  restaurantId    String
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  name            String
  displayName     String?   // Customer-facing name
  selectionType   SelectionType @default(SINGLE)
  minSelection    Int       @default(0)
  maxSelection    Int?
  isRequired      Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  options         ModifierOption[]
  menuItemLinks   MenuItemModifier[]

  @@unique([restaurantId, name])
  @@index([restaurantId])
  @@map("modifier_groups")
}

enum SelectionType {
  SINGLE
  MULTIPLE
}

model ModifierOption {
  id              String    @id @default(uuid())
  groupId         String
  group           ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  name            String
  price           Decimal   @db.Decimal(10, 2) @default(0)
  isDefault       Boolean   @default(false)
  isAvailable     Boolean   @default(true)
  sortOrder       Int       @default(0)

  @@index([groupId, isAvailable, sortOrder])
  @@map("modifier_options")
}

model MenuItemModifier {
  id              String    @id @default(uuid())
  menuItemId      String
  menuItem        MenuItem  @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifierGroupId String
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  sortOrder       Int       @default(0)

  @@unique([menuItemId, modifierGroupId])
  @@map("menu_item_modifiers")
}

// ==================== TABLES & ORDERS ====================

model RestaurantTable {
  id              String    @id @default(uuid())
  restaurantId    String
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  name            String
  capacity        Int       @default(4)
  section         String?
  status          TableStatus @default(AVAILABLE)
  positionX       Int?      // For floor plan
  positionY       Int?
  shape           String?   @default("rectangle") // rectangle, circle, square
  currentOrderId  String?   // Quick reference to active order
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  orders          Order[]

  @@unique([restaurantId, name])
  @@index([restaurantId, status])
  @@index([restaurantId, section])
  @@map("restaurant_tables")
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  BLOCKED
  CLEANING
}

model Order {
  id              String    @id @default(uuid())
  restaurantId    String
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orderNumber     Int       // Per-restaurant sequential number
  displayNumber   String?   // Formatted display number (e.g., "ORD-001")
  orderType       OrderType @default(DINE_IN)
  status          OrderStatus @default(PENDING)

  // Table info (for dine-in)
  tableId         String?
  table           RestaurantTable? @relation(fields: [tableId], references: [id])
  covers          Int?

  // Customer info
  customerName    String?
  customerPhone   String?
  customerAddress String?   // For delivery

  // Channel/Source
  channel         OrderChannel @default(POS)
  externalOrderId String?   // For Swiggy/Zomato orders

  // Amounts (stored for quick access, recalculated on changes)
  subtotal        Decimal   @db.Decimal(10, 2) @default(0)
  taxAmount       Decimal   @db.Decimal(10, 2) @default(0)
  discountAmount  Decimal   @db.Decimal(10, 2) @default(0)
  discountReason  String?
  totalAmount     Decimal   @db.Decimal(10, 2) @default(0)

  // Metadata
  notes           String?
  createdById     String
  createdBy       User      @relation("OrderCreatedBy", fields: [createdById], references: [id])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  confirmedAt     DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelReason    String?

  items           OrderItem[]
  kots            KOT[]
  invoice         Invoice?

  @@unique([restaurantId, orderNumber])
  @@index([restaurantId, status, createdAt])
  @@index([restaurantId, tableId, status])
  @@index([restaurantId, createdAt])
  @@index([restaurantId, channel, createdAt])
  @@map("orders")
}

enum OrderType {
  DINE_IN
  TAKEAWAY
  DELIVERY
}

enum OrderStatus {
  PENDING      // Order created, not yet confirmed
  CONFIRMED    // Order confirmed, ready for kitchen
  PREPARING    // Kitchen is working on it
  READY        // Ready for pickup/serving
  SERVED       // Served to customer (dine-in)
  COMPLETED    // Order completed and paid
  CANCELLED    // Order cancelled
}

enum OrderChannel {
  POS          // Direct POS entry
  DINE_IN      // Dine-in (legacy, use POS)
  TAKEAWAY     // Takeaway counter
  PHONE        // Phone order
  WEBSITE      // Website order
  SWIGGY       // Swiggy integration
  ZOMATO       // Zomato integration
}

model OrderItem {
  id              String    @id @default(uuid())
  orderId         String
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItemId      String
  menuItem        MenuItem  @relation(fields: [menuItemId], references: [id])

  // Denormalized for historical accuracy
  name            String
  quantity        Int
  unitPrice       Decimal   @db.Decimal(10, 2)
  modifiersPrice  Decimal   @db.Decimal(10, 2) @default(0)
  totalPrice      Decimal   @db.Decimal(10, 2)
  taxRate         Decimal   @db.Decimal(5, 2)
  taxAmount       Decimal   @db.Decimal(10, 2) @default(0)

  notes           String?
  status          ItemStatus @default(PENDING)
  kotId           String?
  kot             KOT?      @relation(fields: [kotId], references: [id])

  // Kitchen timing
  sentToKitchenAt DateTime?
  preparedAt      DateTime?
  servedAt        DateTime?

  createdAt       DateTime  @default(now())

  modifiers       OrderItemModifier[]

  @@index([orderId, status])
  @@index([kotId])
  @@map("order_items")
}

enum ItemStatus {
  PENDING          // Not yet sent to kitchen
  SENT_TO_KITCHEN  // KOT printed/sent
  PREPARING        // Kitchen acknowledged
  READY            // Ready to serve
  SERVED           // Served to customer
  CANCELLED        // Item cancelled
}

model OrderItemModifier {
  id              String    @id @default(uuid())
  orderItemId     String
  orderItem       OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifierName    String
  modifierPrice   Decimal   @db.Decimal(10, 2)
  groupName       String?

  @@map("order_item_modifiers")
}

model KOT {
  id              String    @id @default(uuid())
  orderId         String
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  kotNumber       Int       // Per-restaurant sequential
  displayNumber   String?   // Formatted (e.g., "KOT-001")
  station         String?   // Kitchen station (e.g., "grill", "beverages")
  status          KOTStatus @default(PENDING)
  printCount      Int       @default(0)
  printedAt       DateTime?
  acknowledgedAt  DateTime?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())

  items           OrderItem[]

  @@index([orderId])
  @@index([status, createdAt])
  @@map("kots")
}

enum KOTStatus {
  PENDING
  PRINTED
  ACKNOWLEDGED
  PREPARING
  COMPLETED
  VOID
}

// ==================== BILLING ====================

model Invoice {
  id              String    @id @default(uuid())
  restaurantId    String
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orderId         String    @unique
  order           Order     @relation(fields: [orderId], references: [id])

  invoiceNumber   String    // Formatted invoice number
  fiscalYear      String    // e.g., "2024-25"

  // Customer details (for GST invoice)
  customerName    String?
  customerPhone   String?
  customerEmail   String?
  customerGstin   String?
  customerAddress String?

  // Amounts
  subtotal        Decimal   @db.Decimal(10, 2)
  cgst            Decimal   @db.Decimal(10, 2)
  sgst            Decimal   @db.Decimal(10, 2)
  igst            Decimal   @db.Decimal(10, 2) @default(0)
  cess            Decimal   @db.Decimal(10, 2) @default(0)
  discount        Decimal   @db.Decimal(10, 2) @default(0)
  roundOff        Decimal   @db.Decimal(10, 2) @default(0)
  totalAmount     Decimal   @db.Decimal(10, 2)

  status          InvoiceStatus @default(UNPAID)
  paidAt          DateTime?
  voidedAt        DateTime?
  voidReason      String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  payments        Payment[]

  @@unique([restaurantId, invoiceNumber])
  @@index([restaurantId, status, createdAt])
  @@index([restaurantId, fiscalYear])
  @@map("invoices")
}

enum InvoiceStatus {
  UNPAID
  PARTIAL
  PAID
  VOID
  REFUNDED
}

model Payment {
  id              String    @id @default(uuid())
  invoiceId       String
  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  amount          Decimal   @db.Decimal(10, 2)
  method          PaymentMethod
  status          PaymentStatus @default(COMPLETED)

  // For cash payments
  receivedAmount  Decimal?  @db.Decimal(10, 2)
  changeAmount    Decimal?  @db.Decimal(10, 2)

  // For digital payments
  transactionId   String?
  paymentGateway  String?

  processedById   String
  processedBy     User      @relation(fields: [processedById], references: [id])

  notes           String?
  createdAt       DateTime  @default(now())

  @@index([invoiceId])
  @@index([method, createdAt])
  @@map("payments")
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  WALLET
  CREDIT     // Pay later / Tab
  SPLIT      // Split payment marker
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ==================== AI ====================

model AIConversation {
  id              String    @id @default(uuid())
  restaurantId    String
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  sessionId       String?   // For tracking conversation context
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  messages        AIMessage[]

  @@index([restaurantId, userId, createdAt])
  @@map("ai_conversations")
}

model AIMessage {
  id              String    @id @default(uuid())
  conversationId  String
  conversation    AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role            MessageRole
  content         String
  intent          String?
  confidence      Float?
  entities        Json?
  actionTaken     Json?
  processingTime  Int?      // in milliseconds
  createdAt       DateTime  @default(now())

  @@index([conversationId, createdAt])
  @@map("ai_messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model AIAction {
  id              String    @id @default(uuid())
  restaurantId    String
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  conversationId  String?
  actionType      String
  targetEntity    String
  targetId        String?
  previousValue   Json?
  newValue        Json?
  status          ActionStatus @default(COMPLETED)
  errorMessage    String?
  createdAt       DateTime  @default(now())

  @@index([restaurantId, createdAt])
  @@index([restaurantId, actionType, createdAt])
  @@map("ai_actions")
}

enum ActionStatus {
  PENDING
  COMPLETED
  FAILED
  ROLLED_BACK
}
